name: CLA Agreement Checker

on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: read

jobs:
  check-cla:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - name: Check CLA Comment
        uses: actions/github-script@v7
        with:
          script: |
            const comment = context.payload.comment.body.trim().toLowerCase();
            const username = context.payload.comment.user.login;
            const claPhrase = "i agree to the cla";

            if (comment === claPhrase) {
              const fs = require('fs');
              const path = '.github/cla/signed-contributors.json';
              const octokit = github.getOctokit(process.env.GITHUB_TOKEN);

              const { data: pr } = await octokit.rest.pulls.get({
                ...context.repo,
                pull_number: context.issue.number
              });

              // Fetch the latest signed-contributors.json file
              const { data: fileData } = await octokit.rest.repos.getContent({
                ...context.repo,
                path
              });

              const content = Buffer.from(fileData.content, 'base64').toString();
              const json = JSON.parse(content);

              if (!json.users.includes(username)) {
                json.users.push(username);

                const newContent = Buffer.from(JSON.stringify(json, null, 2)).toString('base64');

                await octokit.rest.repos.createOrUpdateFileContents({
                  ...context.repo,
                  path,
                  message: `CLA agreement from @${username}`,
                  content: newContent,
                  sha: fileData.sha,
                  committer: {
                    name: "CLA Bot",
                    email: "cla-bot@example.com"
                  },
                  author: {
                    name: "CLA Bot",
                    email: "cla-bot@example.com"
                  }
                });
              }
            }
